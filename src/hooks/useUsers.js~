"use client";
import { useState, useEffect } from "react";
import axios from "axios";
import { useAuth } from "@/context/authContext";

export function useUsers({ searchTerm, filterDate, customStartDate, customEndDate }) {
    const { token } = useAuth();
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    
    // Ensure searchTerm is always a string
    const safeSearchTerm = searchTerm || "";
    
    const fetchUsers = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
            if (token) {
                const response = await axios.get("/api/test", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });
                setUsers(response.data);
            }
        } catch (err) {
            setError(err.message || "An error occurred while fetching test.");
        } finally {
            setLoading(false);
        }
    }, [token]);
    
    useEffect(() => {
        fetchUsers();
    }, [fetchUsers]);
    
    // Filter test based on search term and date filters.
    const filteredUsers = users.filter((user) => {
        const searchTermLower = safeSearchTerm.toLowerCase(); // Use the safeSearchTerm
        
        const displayNameLower = user?.displayName ? user.displayName.toLowerCase() : "";
        const emailLower = user?.email ? user.email.toLowerCase() : "";
        
        const searchMatch =
            displayNameLower.includes(searchTermLower) ||
            emailLower.includes(searchTermLower);
        
        let dateMatch = true;
        
        if (filterDate) {
            const userDate = user?.createdAt ? new Date(user.createdAt).toISOString().split("T")[0] : null;
            
            if (userDate) {
                if (filterDate === "today") {
                    const today = new Date().toISOString().split("T")[0];
                    dateMatch = userDate === today;
                } else if (filterDate === "yesterday") {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split("T")[0];
                    dateMatch = userDate === yesterdayStr;
                } else if (filterDate === "custom" && customStartDate && customEndDate) {
                    if (
                        new Date(customStartDate).toString() !== "Invalid Date" &&
                        new Date(customEndDate).toString() !== "Invalid Date"
                    ) {
                        const startDate = new Date(customStartDate).toISOString().split("T")[0];
                        const endDate = new Date(customEndDate).toISOString().split("T")[0];
                        dateMatch = userDate >= startDate && userDate <= endDate;
                    } else {
                        dateMatch = false;
                    }
                }
            } else {
                dateMatch = false;
            }
        }
        
        return searchMatch && dateMatch;
    });
    
    // Calculate total user counts per role based on the fetched test.
    const roleCounts = filteredUsers.reduce((acc, user) => {
        const role = user?.role || "Unknown";
        acc[role] = (acc[role] || 0) + 1;
        return acc;
    }, {});
    
    return { filteredUsers, loading, error, roleCounts };
}