import admin from '@/lib/firebaseAdmin';
import { getUserFromMongoDB } from '@/lib/users';
import { NextResponse } from 'next/server';

export function withAuth(handler, allowedRoles ) {
    return async (req, ctx) => { // Change from (req) to (req, ctx)
        const authHeader = req.headers.get('authorization');
        
        if (!authHeader || !authHeader.startsWith('Bearer ')) {
            console.log('Authorization header is missing or malformed');
            return NextResponse.json({ error: 'Authorization header is missing or malformed' }, { status: 401 });
        }
        
        const token = authHeader.split(' ')[1];
        console.log('Token:', token);
        console.log('Running withAuth middleware');
        
        try {
            const decodedToken = await admin.auth().verifyIdToken(token);
            
            const user = await getUserFromMongoDB(decodedToken.email);
            
            if (!user) {
                console.log('User not found');
                return NextResponse.json({ error: 'User not found' }, { status: 404 });
            }
            
            req.user = {
                ...decodedToken,
                role: user.role,
            };
            
            if (allowedRoles.length > 0 && !allowedRoles.includes(req.user.role)) {
                return NextResponse.json({ error: 'Forbidden: Insufficient permissions' }, { status: 403 });
            }
            
            return handler(req, ctx); // Pass the context (ctx) to the handler
        } catch (error) {
            if (error.code === 'auth/id-token-expired') {
                console.error('Token has expired');
                return NextResponse.json({ error: 'Token has expired' }, { status: 401 });
            }
            console.error('Token verification failed:', error);
            return NextResponse.json({ error: 'Invalid or expired token' }, { status: 401 });
        }
    };
}